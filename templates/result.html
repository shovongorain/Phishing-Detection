<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Result - Phishing Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i> Phishing Detector
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="#share">Share</a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <!-- Back Button -->
        <div class="mb-4">
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Scanner
            </a>
        </div>

        <!-- Main Result Card -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-gradient 
                {% if result.risk_level == 'High' %}bg-danger
                {% elif result.risk_level == 'Medium' %}bg-warning
                {% else %}bg-success{% endif %} text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-0">
                            <i class="fas 
                                {% if result.risk_level == 'High' %}fa-exclamation-triangle
                                {% elif result.risk_level == 'Medium' %}fa-exclamation-circle
                                {% else %}fa-check-circle{% endif %}"></i>
                            Scan Result: {{ result.prediction }}
                        </h3>
                        <p class="mb-0 mt-2">
                            <i class="fas fa-link"></i> {{ result.url }}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-light text-dark fs-6 p-2">
                            Confidence: {{ result.confidence }}%
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Risk Summary -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Risk Level</h6>
                                <h2 class="display-6 
                                    {% if result.risk_level == 'High' %}text-danger
                                    {% elif result.risk_level == 'Medium' %}text-warning
                                    {% else %}text-success{% endif %}">
                                    {{ result.risk_level }}
                                </h2>
                                <div class="progress mt-3" style="height: 10px;">
                                    <div class="progress-bar 
                                        {% if result.risk_level == 'High' %}bg-danger
                                        {% elif result.risk_level == 'Medium' %}bg-warning
                                        {% else %}bg-success{% endif %}" 
                                        style="width: {{ result.risk_score }}%">
                                    </div>
                                </div>
                                <small class="text-muted">Risk Score: {{ result.risk_score }}/100</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Scan Time</h6>
                                <h2 class="display-6 text-primary">
                                    <i class="fas fa-clock"></i>
                                </h2>
                                <p class="card-text">{{ result.timestamp }}</p>
                                <small class="text-muted">Real-time Analysis</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Model Accuracy</h6>
                                <h2 class="display-6 text-success">92%</h2>
                                <p class="card-text">Random Forest Classifier</p>
                                <small class="text-muted">11 Features Analyzed</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="row">
                    <!-- Domain Information -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-globe"></i> Domain Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless">
                                    <tbody>
                                        <tr>
                                            <th width="40%">Full URL:</th>
                                            <td><code>{{ result.url }}</code></td>
                                        </tr>
                                        <tr>
                                            <th>Domain:</th>
                                            <td>
                                                <strong>{{ result.analysis.domain_info.full_domain }}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Protocol:</th>
                                            <td>
                                                <span class="badge {% if result.analysis.security_indicators.has_https %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ result.analysis.domain_info.scheme|upper }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Subdomain:</th>
                                            <td>
                                                {% if result.analysis.domain_info.subdomain %}
                                                    {{ result.analysis.domain_info.subdomain }}
                                                {% else %}
                                                    <span class="text-muted">None</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Path:</th>
                                            <td>
                                                {% if result.analysis.domain_info.path %}
                                                    <code>{{ result.analysis.domain_info.path[:50] }}{% if result.analysis.domain_info.path|length > 50 %}...{% endif %}</code>
                                                {% else %}
                                                    <span class="text-muted">/</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Security Indicators -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-shield-alt"></i> Security Indicators
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% set indicators = [
                                        ('Has HTTPS', result.analysis.security_indicators.has_https, 'Encrypted connection'),
                                        ('No IP Address', not result.analysis.security_indicators.has_ip, 'Uses domain name'),
                                        ('Not Shortened', not result.analysis.security_indicators.is_shortened, 'Original URL'),
                                        ('Valid TLD', not result.analysis.security_indicators.suspicious_tld, 'Common domain extension'),
                                        ('No @ Symbol', not result.analysis.security_indicators.has_at_symbol, 'No redirection'),
                                        ('Safe Redirect', not result.analysis.security_indicators.double_slash_redirect, 'Proper URL structure')
                                    ] %}
                                    
                                    {% for name, status, desc in indicators %}
                                    <div class="col-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if status %}
                                                <i class="fas fa-check-circle text-success fa-lg"></i>
                                                {% else %}
                                                <i class="fas fa-times-circle text-danger fa-lg"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ desc }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL Statistics -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar"></i> URL Statistics
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 col-6 text-center mb-3">
                                        <div class="stat-box p-3 border rounded">
                                            <h3 class="text-primary">{{ result.analysis.statistics.url_length }}</h3>
                                            <small class="text-muted">URL Length</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 text-center mb-3">
                                        <div class="stat-box p-3 border rounded">
                                            <h3 class="text-warning">{{ result.analysis.statistics.special_char_count }}</h3>
                                            <small class="text-muted">Special Characters</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 text-center mb-3">
                                        <div class="stat-box p-3 border rounded">
                                            <h3 class="text-info">{{ result.analysis.statistics.digit_count }}</h3>
                                            <small class="text-muted">Digits</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 text-center mb-3">
                                        <div class="stat-box p-3 border rounded">
                                            <h3 class="text-success">{{ result.analysis.statistics.subdomain_count }}</h3>
                                            <small class="text-muted">Subdomains</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Chart -->
                                <div class="mt-4">
                                    <canvas id="statsChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Factors -->
                {% if result.analysis.risk_factors %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> Risk Factors Detected
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-danger">
                                    <i class="fas fa-info-circle"></i>
                                    The following risk factors were identified in this URL:
                                </div>
                                
                                <div class="row">
                                    {% for factor in result.analysis.risk_factors %}
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-exclamation text-danger mt-1 me-2"></i>
                                            <span>{{ factor }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="alert alert-warning mt-3">
                                    <h6><i class="fas fa-lightbulb"></i> Safety Recommendations:</h6>
                                    <ul class="mb-0">
                                        <li>Do not enter personal information on this website</li>
                                        <li>Verify the URL with the official source</li>
                                        <li>Check for HTTPS and valid SSL certificates</li>
                                        <li>Be cautious of unsolicited links in emails</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Safe URL Message -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle"></i> Safety Assessment
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-shield-check"></i> This URL appears to be safe</h5>
                                    <p class="mb-0">No significant risk factors were detected. However, always practice good security habits.</p>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6><i class="fas fa-thumbs-up"></i> Positive Indicators:</h6>
                                                <ul class="mb-0">
                                                    <li>Valid domain structure</li>
                                                    <li>Appropriate URL length</li>
                                                    <li>No suspicious characters</li>
                                                    <li>Standard domain extension</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6><i class="fas fa-lightbulb"></i> General Safety Tips:</h6>
                                                <ul class="mb-0">
                                                    <li>Always check for HTTPS</li>
                                                    <li>Verify website certificates</li>
                                                    <li>Use strong, unique passwords</li>
                                                    <li>Enable two-factor authentication</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Feature Importance -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-brain"></i> Machine Learning Analysis
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Model Information:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Algorithm:</strong> Random Forest Classifier</li>
                                            <li><strong>Accuracy:</strong> 92%</li>
                                            <li><strong>Prediction:</strong> {{ result.prediction }}</li>
                                            <li><strong>Confidence:</strong> {{ result.confidence }}%</li>
                                            <li><strong>Features Analyzed:</strong> 11 parameters</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Top Contributing Features:</h6>
                                        <div class="progress-container">
                                            {% set features = [
                                                ('URL Length', 15),
                                                ('Special Characters', 12),
                                                ('HTTPS Presence', 18),
                                                ('Subdomain Count', 10),
                                                ('IP Address', 14),
                                                ('URL Shortener', 11)
                                            ] %}
                                            
                                            {% for name, value in features %}
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <small>{{ name }}</small>
                                                    <small>{{ value }}%</small>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-info" style="width: {{ value }}%"></div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="mb-4">What would you like to do next?</h5>
                                <div class="d-flex flex-wrap justify-content-center gap-3">
                                    <a href="/" class="btn btn-primary btn-lg">
                                        <i class="fas fa-search"></i> Scan Another URL
                                    </a>
                                    <a href="/dashboard" class="btn btn-info btn-lg">
                                        <i class="fas fa-chart-bar"></i> View Dashboard
                                    </a>
                                    <button class="btn btn-success btn-lg" onclick="shareResult()" id="share">
                                        <i class="fas fa-share-alt"></i> Share Result
                                    </button>
                                    <button class="btn btn-outline-danger btn-lg" onclick="reportUrl()">
                                        <i class="fas fa-flag"></i> Report URL
                                    </button>
                                </div>
                                
                                <!-- Share Links -->
                                <div id="shareLinks" class="mt-4" style="display: none;">
                                    <h6>Share this result:</h6>
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-outline-primary">
                                            <i class="fab fa-twitter"></i> Twitter
                                        </button>
                                        <button class="btn btn-outline-primary">
                                            <i class="fab fa-facebook"></i> Facebook
                                        </button>
                                        <button class="btn btn-outline-primary">
                                            <i class="fab fa-linkedin"></i> LinkedIn
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="copyToClipboard()">
                                            <i class="fas fa-copy"></i> Copy Link
                                        </button>
                                    </div>
                                    <div id="copyAlert" class="alert alert-success mt-3" style="display: none;">
                                        <i class="fas fa-check"></i> Link copied to clipboard!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted text-center">
                <small>
                    <i class="fas fa-info-circle"></i>
                    This analysis is based on machine learning predictions. Always verify suspicious URLs through multiple sources.
                    Scan performed on {{ result.timestamp }}
                </small>
            </div>
        </div>

        <!-- Similar Scans -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Recent Similar Scans
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>URL</th>
                                <th>Result</th>
                                <th>Risk</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="similarScans">
                            <!-- Will be populated by JavaScript -->
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Phishing Detection System</h5>
                    <p class="mb-0">Built with Flask and Scikit-learn</p>
                    <p class="mb-0">Model Accuracy: 92% | Random Forest Algorithm</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="mb-1">Real-time URL Analysis</p>
                    <p class="mb-0">11 Feature Parameters | Machine Learning Powered</p>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center">
                <small>
                    &copy; 2024 Phishing Detection System. For educational purposes only.
                    Always verify suspicious URLs through official channels.
                </small>
            </div>
        </div>
    </footer>

    <script>
        // Initialize chart
        document.addEventListener('DOMContentLoaded', function() {
            // Statistics Chart
            const ctx = document.getElementById('statsChart').getContext('2d');
            const statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Length', 'Special Chars', 'Digits', 'Subdomains', 'Path Depth', 'Hyphens'],
                    datasets: [{
                        label: 'Count',
                        data: [
                            {{ result.analysis.statistics.url_length }},
                            {{ result.analysis.statistics.special_char_count }},
                            {{ result.analysis.statistics.digit_count }},
                            {{ result.analysis.statistics.subdomain_count }},
                            {{ result.analysis.statistics.path_depth }},
                            {{ result.analysis.statistics.hyphen_count }}
                        ],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 205, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgb(54, 162, 235)',
                            'rgb(255, 99, 132)',
                            'rgb(75, 192, 192)',
                            'rgb(255, 159, 64)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 205, 86)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Load similar scans
            loadSimilarScans();
        });

        function shareResult() {
            const shareLinks = document.getElementById('shareLinks');
            shareLinks.style.display = shareLinks.style.display === 'none' ? 'block' : 'none';
        }

        function copyToClipboard() {
            const currentUrl = window.location.href;
            navigator.clipboard.writeText(currentUrl).then(() => {
                const alert = document.getElementById('copyAlert');
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            });
        }

        function reportUrl() {
            if (confirm('Report this URL as malicious? This will help improve our detection system.')) {
                alert('Thank you for your report. The URL has been flagged for review.');
                // In a real application, you would send this to your backend
                fetch('/api/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: '{{ result.url }}',
                        reason: 'user_report'
                    })
                });
            }
        }

        async function loadSimilarScans() {
            try {
                const response = await fetch('/api/history');
                const scans = await response.json();
                
                const similarScansDiv = document.getElementById('similarScans');
                let html = '';
                
                // Filter scans with same prediction type
                const similarScans = scans
                    .filter(scan => scan.prediction === '{{ result.prediction }}')
                    .slice(0, 5);
                
                if (similarScans.length === 0) {
                    html = '<tr><td colspan="5" class="text-center">No similar scans found</td></tr>';
                } else {
                    similarScans.forEach(scan => {
                        const riskClass = scan.risk_level === 'High' ? 'danger' : 
                                        scan.risk_level === 'Medium' ? 'warning' : 'success';
                        
                        html += `
                            <tr>
                                <td>${scan.timestamp.split(' ')[1]}</td>
                                <td>
                                    <small title="${scan.url}">
                                        ${scan.url.substring(0, 30)}${scan.url.length > 30 ? '...' : ''}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-${scan.prediction === 'Phishing' ? 'danger' : 'success'}">
                                        ${scan.prediction}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-${riskClass}">${scan.risk_level}</span>
                                </td>
                                <td>${scan.confidence}%</td>
                            </tr>
                        `;
                    });
                }
                
                similarScansDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading similar scans:', error);
                document.getElementById('similarScans').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">Error loading similar scans</td></tr>';
            }
        }

        // Print result
        function printResult() {
            window.print();
        }

        // Download result as PDF/Text
        function downloadResult(format) {
            const content = `
Phishing Detection System - Scan Report
========================================
URL: {{ result.url }}
Scan Time: {{ result.timestamp }}
Result: {{ result.prediction }}
Risk Level: {{ result.risk_level }}
Confidence: {{ result.confidence }}%
Risk Score: {{ result.risk_score }}/100

Domain Information:
-------------------
Full Domain: {{ result.analysis.domain_info.full_domain }}
Protocol: {{ result.analysis.domain_info.scheme }}
Subdomain: {{ result.analysis.domain_info.subdomain }}

Security Indicators:
--------------------
HTTPS: {{ result.analysis.security_indicators.has_https }}
IP Address: {{ result.analysis.security_indicators.has_ip }}
URL Shortener: {{ result.analysis.security_indicators.is_shortened }}
Suspicious TLD: {{ result.analysis.security_indicators.suspicious_tld }}

Statistics:
-----------
URL Length: {{ result.analysis.statistics.url_length }}
Special Characters: {{ result.analysis.statistics.special_char_count }}
Digits: {{ result.analysis.statistics.digit_count }}
Subdomains: {{ result.analysis.statistics.subdomain_count }}

{% if result.analysis.risk_factors %}
Risk Factors Detected:
-----------------------
{% for factor in result.analysis.risk_factors %}
â€¢ {{ factor }}
{% endfor %}
{% endif %}

Model Information:
------------------
Algorithm: Random Forest Classifier
Accuracy: 92%
Features Analyzed: 11

=== END OF REPORT ===
Generated by Phishing Detection System
`;
            
            if (format === 'text') {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'phishing-scan-report.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>